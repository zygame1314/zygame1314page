var I=Object.defineProperty;var B=(U,e,t)=>e in U?I(U,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):U[e]=t;var p=(U,e,t)=>B(U,typeof e!="symbol"?e+"":e,t);import"./animations-BWIQC-bF.js";var b;let A=(b=class{static formatDate(e,t="YYYY-MM-DD"){const a=new Date(e),i=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),o=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0"),l=String(a.getSeconds()).padStart(2,"0");switch(t){case"YYYY-MM-DD":return`${i}-${s}-${n}`;case"YYYY-MM-DD HH:mm":return`${i}-${s}-${n} ${o}:${r}`;case"YYYY-MM-DD HH:mm:ss":return`${i}-${s}-${n} ${o}:${r}:${l}`;case"MM-DD":return`${s}-${n}`;case"HH:mm":return`${o}:${r}`;default:return`${i}-${s}-${n}`}}static formatMoney(e){return typeof e=="string"&&(e=parseFloat(e)),e.toFixed(2)}static debounce(e,t){let a;return function(...s){const n=()=>{clearTimeout(a),e(...s)};clearTimeout(a),a=setTimeout(n,t)}}static throttle(e,t){let a;return function(){const i=arguments,s=this;a||(e.apply(s,i),a=!0,setTimeout(()=>a=!1,t))}}static deepClone(e){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(e instanceof Array)return e.map(t=>b.deepClone(t));if(typeof e=="object"){const t={};for(const a in e)e.hasOwnProperty(a)&&(t[a]=b.deepClone(e[a]));return t}}static generateId(){return Math.random().toString(36).substr(2,9)}static validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static validateUrl(e){try{return new URL(e),!0}catch{return!1}}static truncateText(e,t){return e.length<=t?e:e.substr(0,t)+"..."}static escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}static getFileExtension(e){return e.slice((e.lastIndexOf(".")-1>>>0)+2)}static formatFileSize(e){if(e===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+a[i]}static getUrlParam(e){return new URLSearchParams(window.location.search).get(e)}static setUrlParam(e,t){const a=new URL(window.location);a.searchParams.set(e,t),window.history.pushState({},"",a)}static removeUrlParam(e){const t=new URL(window.location);t.searchParams.delete(e),window.history.pushState({},"",t)}static async copyToClipboard(e){try{return await navigator.clipboard.writeText(e),!0}catch{const a=document.createElement("textarea");a.value=e,document.body.appendChild(a),a.select();const i=document.execCommand("copy");return document.body.removeChild(a),i}}static isMobile(){return window.innerWidth<=768}static scrollToElement(e,t=0){const a=e.offsetTop-t;window.scrollTo({top:a,behavior:"smooth"})}static formatRelativeTime(e){const t=new Date,a=new Date(e),i=t-a,s=Math.floor(i/1e3),n=Math.floor(s/60),o=Math.floor(n/60),r=Math.floor(o/24),l=Math.floor(r/30),c=Math.floor(r/365);return s<60?"刚刚":n<60?`${n}分钟前`:o<24?`${o}小时前`:r<30?`${r}天前`:l<12?`${l}个月前`:`${c}年前`}},p(b,"storage",{set(e,t){try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(a){return console.error("Storage set error:",a),!1}},get(e,t=null){try{const a=localStorage.getItem(e);return a?JSON.parse(a):t}catch(a){return console.error("Storage get error:",a),t}},remove(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("Storage remove error:",t),!1}},clear(){try{return localStorage.clear(),!0}catch(e){return console.error("Storage clear error:",e),!1}}}),p(b,"sessionStorage",{set(e,t){try{return sessionStorage.setItem(e,JSON.stringify(t)),!0}catch(a){return console.error("Session storage set error:",a),!1}},get(e,t=null){try{const a=sessionStorage.getItem(e);return a?JSON.parse(a):t}catch(a){return console.error("Session storage get error:",a),t}},remove(e){try{return sessionStorage.removeItem(e),!0}catch(t){return console.error("Session storage remove error:",t),!1}},clear(){try{return sessionStorage.clear(),!0}catch(e){return console.error("Session storage clear error:",e),!1}}}),p(b,"colorUtils",{random(){return`#${Math.floor(Math.random()*16777215).toString(16)}`},hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},rgbToHex(e,t,a){return`#${((1<<24)+(e<<16)+(t<<8)+a).toString(16).slice(1)}`},getContrastColor(e){const t=this.hexToRgb(e);return t?(t.r*299+t.g*587+t.b*114)/1e3>128?"#000000":"#ffffff":"#000000"}}),p(b,"arrayUtils",{unique(e){return[...new Set(e)]},groupBy(e,t){return e.reduce((a,i)=>{const s=i[t];return a[s]||(a[s]=[]),a[s].push(i),a},{})},sortBy(e,t,a="asc"){return e.sort((i,s)=>{const n=i[t],o=s[t];return a==="asc"?n>o?1:-1:n<o?1:-1})},paginate(e,t,a){const i=(t-1)*a,s=i+a;return e.slice(i,s)},search(e,t,a){const i=t.toLowerCase();return e.filter(s=>a.some(n=>{const o=s[n];return o&&o.toString().toLowerCase().includes(i)}))}}),p(b,"domUtils",{createElement(e,t={},a=[]){const i=document.createElement(e);return Object.keys(t).forEach(s=>{s==="className"?i.className=t[s]:s==="innerHTML"?i.innerHTML=t[s]:s==="textContent"?i.textContent=t[s]:i.setAttribute(s,t[s])}),a.forEach(s=>{typeof s=="string"?i.appendChild(document.createTextNode(s)):i.appendChild(s)}),i},addEventListeners(e,t){Object.keys(t).forEach(a=>{e.addEventListener(a,t[a])})},clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)},toggleClass(e,t){e.classList.toggle(t)},getElementPosition(e){const t=e.getBoundingClientRect();return{top:t.top+window.scrollY,left:t.left+window.scrollX,width:t.width,height:t.height}}}),p(b,"imageUtils",{async compressAndConvertToWebP(e,t=.8){return new Promise((a,i)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=n=>{const o=new Image;o.src=n.target.result,o.onload=()=>{const r=document.createElement("canvas"),l=r.getContext("2d");r.width=o.width,r.height=o.height,l.drawImage(o,0,0),r.toBlob(c=>{c?a(new File([c],e.name.replace(/\.[^/.]+$/,".webp"),{type:"image/webp"})):i(new Error("无法将Canvas转换为Blob"))},"image/webp",t)},o.onerror=r=>i(r)},s.onerror=n=>i(n)})}}),p(b,"validation",{rules:{required:e=>e&&e.trim()!=="",email:e=>b.validateEmail(e),url:e=>b.validateUrl(e),minLength:e=>t=>t&&t.length>=e,maxLength:e=>t=>t&&t.length<=e,number:e=>!isNaN(e),positiveNumber:e=>!isNaN(e)&&Number(e)>0},validateField(e,t){const a=[];return t.forEach(i=>{typeof i=="function"?i(e)||a.push("验证失败"):typeof i=="object"&&(i.validator(e)||a.push(i.message||"验证失败"))}),{isValid:a.length===0,errors:a}},validateForm(e,t){const a={};let i=!0;return Object.keys(t).forEach(s=>{const n=t[s],o=e[s],r=this.validateField(o,n);r.isValid||(a[s]=r.errors,i=!1)}),{isValid:i,errors:a}}}),b);window.Utils=A;class ${constructor(){p(this,"donations",{getList:async(e=1,t=10,a=null)=>{const i={page:e,limit:t};return a&&(i.platform=a),this.get("/getdata/donations",i)},add:async e=>this.post("/getdata/donations",e),update:async e=>this.put("/getdata/donations",e),delete:async e=>this.delete("/getdata/donations",{id:e})});p(this,"music",{getPlaylist:async()=>this.get("/getdata/playlist"),add:async e=>this.post("/getdata/playlist",e),update:async e=>this.put("/getdata/playlist",e),delete:async e=>this.delete("/getdata/playlist",{id:e})});p(this,"projects",{getList:async(e=1,t=20)=>this.get("/getdata/projects",{page:e,limit:t}),add:async e=>this.post("/getdata/projects",e),update:async e=>this.put("/getdata/projects",e),delete:async e=>this.delete("/getdata/projects",{id:e})});p(this,"notices",{getList:async()=>this.get("/getdata/notices"),add:async e=>this.post("/getdata/notices",e),update:async e=>this.put("/getdata/notices",e),delete:async e=>this.delete("/getdata/notices",{id:e})});p(this,"timeline",{getList:async(e=1,t=50)=>this.get("/getdata/timeline",{page:e,limit:t}),add:async e=>this.post("/getdata/timeline",e),update:async e=>this.put("/getdata/timeline",e),delete:async e=>this.delete("/getdata/timeline",{id:e})});p(this,"importantNotices",{getList:async()=>this.get("/getdata/important-notice?admin=true"),update:async e=>this.put("/getdata/important-notice",e),delete:async e=>this.delete("/getdata/important-notice",{id:e})});p(this,"importantNotice",{get:async()=>this.get("/getdata/important-notice"),update:async e=>this.put("/getdata/important-notice",e),add:async e=>this.put("/getdata/important-notice",e)});p(this,"status",{getHistory:async(e=60)=>this.get("/check/status-history",{minutes:e}),getScripts:async()=>this.get("/check/scripts")});p(this,"poll",{vote:async(e,t)=>this.post("/notice/vote",{noticeId:e,options:t}),getResults:async e=>this.get("/notice/poll-results",{noticeId:e}),hasVoted:async e=>this.get("/notice/has-voted",{noticeId:e})});p(this,"games",{getPopular:async()=>this.get("/games/popular"),getRecent:async()=>this.get("/games/recent-games"),getSteamStatus:async()=>this.get("/games/steam-status")});p(this,"weather",{get:async()=>this.get("/weather/weather")});p(this,"comment",{uploadImage:async e=>{const t=new FormData;t.append("image",e);const a=await fetch(`${this.baseURL}/comment/upload-image`,{method:"POST",body:t});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return await a.json()}});p(this,"articles",{getList:async(e=1,t=10)=>this.get("/getdata/articles",{page:e,limit:t}),getById:async e=>this.get("/getdata/articles",{id:e}),add:async e=>this.post("/getdata/articles",e),update:async e=>this.put("/getdata/articles",e),delete:async e=>this.delete("/getdata/articles",{id:e}),getPublicList:async()=>this.get("/article/list"),getSummary:async e=>this.get("/article/summarize",{id:e})});this.baseURL="https://api.zygame1314.site",this.defaultHeaders={"Content-Type":"application/json"}}async _request(e,t={}){const a=localStorage.getItem("authToken"),i={...this.defaultHeaders,...t.headers};a&&(i.Authorization=`Bearer ${a}`);const s={headers:i,...t};try{const n=await fetch(`${this.baseURL}${e}`,s);if(n.status===401){localStorage.removeItem("authToken"),window.location.href="login.html";return}if(!n.ok){const r=await n.json().catch(()=>({error:`HTTP error! status: ${n.status}`}));throw new Error(r.error||`HTTP error! status: ${n.status}`)}return await n.json()}catch(n){throw console.error("API request failed:",n),n}}async get(e,t={}){const a=new URL(`${this.baseURL}${e}`,window.location.origin);return Object.keys(t).forEach(i=>{t[i]!==null&&t[i]!==void 0&&a.searchParams.append(i,t[i])}),this._request(a.pathname+a.search,{method:"GET"})}async post(e,t={}){return this._request(e,{method:"POST",body:JSON.stringify(t)})}async put(e,t={}){return this._request(e,{method:"PUT",body:JSON.stringify(t)})}async delete(e,t={}){const a=new URL(`${this.baseURL}${e}`,window.location.origin);return Object.keys(t).forEach(i=>{t[i]!==null&&t[i]!==void 0&&a.searchParams.append(i,t[i])}),this._request(a.pathname+a.search,{method:"DELETE"})}async _getArticlesFromHTML(){try{return{articles:[{id:"activation-code-mechanism",title:"激活码机制详解",description:"详细介绍激活码的工作原理和实现机制",date:"2024-01-15",tags:["技术","教程"]},{id:"broke-webmaster-survival",title:"破产站长生存指南",description:"如何在预算有限的情况下维护个人网站",date:"2024-01-10",tags:["经验","建站"]},{id:"cloudflare-pages-bing-seo-prerendering-fix",title:"Cloudflare Pages Bing SEO 预渲染修复",description:"解决Cloudflare Pages在Bing搜索引擎中的SEO问题",date:"2024-01-08",tags:["SEO","Cloudflare"]}]}}catch(e){return console.error("Failed to get articles:",e),{articles:[]}}}async uploadFile(e,t="/upload"){const a=new FormData;a.append("file",e);try{const i=await fetch(`${this.baseURL}${t}`,{method:"POST",body:a});if(!i.ok)throw new Error(`Upload failed! status: ${i.status}`);return await i.json()}catch(i){throw console.error("File upload failed:",i),i}}async getSystemStatus(){try{const e=await Promise.allSettled([this.donations.getList(1,1),this.music.getPlaylist(),this.projects.getList(1,1),this.notices.getList()]),t={donations:e[0].status==="fulfilled",music:e[1].status==="fulfilled",projects:e[2].status==="fulfilled",notices:e[3].status==="fulfilled"};return{overall:Object.values(t).every(i=>i)?"healthy":"degraded",services:t,timestamp:new Date().toISOString()}}catch(e){return console.error("Failed to get system status:",e),{overall:"error",services:{},timestamp:new Date().toISOString(),error:e.message}}}async batchOperation(e){const t=[];for(const a of e)try{const i=await this._request(a.url,a.options);t.push({success:!0,data:i})}catch(i){t.push({success:!1,error:i.message})}return t}async getStatistics(){try{const[e,t,a,i]=await Promise.allSettled([this.donations.getList(1,1),this.music.getPlaylist(),this.projects.getList(1,1),this.notices.getList()]),s={totalDonations:0,totalSongs:0,totalProjects:0,totalNotices:0};return e.status==="fulfilled"&&e.value.pagination&&(s.totalDonations=e.value.pagination.total),t.status==="fulfilled"&&t.value.songs&&(s.totalSongs=t.value.songs.length),a.status==="fulfilled"&&a.value.pagination&&(s.totalProjects=a.value.pagination.total),i.status==="fulfilled"&&i.value.notices&&(s.totalNotices=i.value.notices.length),s}catch(e){return console.error("Failed to get statistics:",e),{totalDonations:0,totalSongs:0,totalProjects:0,totalNotices:0}}}async search(e,t="all"){const a={donations:[],music:[],projects:[],notices:[]};try{if(t==="all"||t==="donations"){const i=await this.donations.getList(1,100);i.data&&(a.donations=i.data.filter(s=>{var n,o;return((n=s.name)==null?void 0:n.toLowerCase().includes(e.toLowerCase()))||((o=s.message)==null?void 0:o.toLowerCase().includes(e.toLowerCase()))}))}if(t==="all"||t==="music"){const i=await this.music.getPlaylist();i.songs&&(a.music=i.songs.filter(s=>{var n,o;return((n=s.title)==null?void 0:n.toLowerCase().includes(e.toLowerCase()))||((o=s.artist)==null?void 0:o.toLowerCase().includes(e.toLowerCase()))}))}if(t==="all"||t==="projects"){const i=await this.projects.getList(1,100);i.projects&&(a.projects=i.projects.filter(s=>{var n,o;return((n=s.title)==null?void 0:n.toLowerCase().includes(e.toLowerCase()))||((o=s.description)==null?void 0:o.toLowerCase().includes(e.toLowerCase()))}))}if(t==="all"||t==="notices"){const i=await this.notices.getList();i.notices&&(a.notices=i.notices.filter(s=>{var n,o;return((n=s.title)==null?void 0:n.toLowerCase().includes(e.toLowerCase()))||((o=JSON.stringify(s.content))==null?void 0:o.toLowerCase().includes(e.toLowerCase()))}))}return a}catch(i){return console.error("Search failed:",i),a}}}const H=new $;window.API=$;window.api=H;var v;let N=(v=class{},p(v,"notification",{container:null,init(){this.container=document.getElementById("notifications"),this.container||(this.container=document.createElement("div"),this.container.id="notifications",this.container.className="notifications",document.body.appendChild(this.container))},show(e,t="info",a=5e3,i=null){this.container||this.init();const s=Utils.domUtils.createElement("div",{className:`notification ${t}`}),n={success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"}[t]||"fas fa-info-circle";return s.innerHTML=`
                <i class="notification-icon ${n}"></i>
                <div class="notification-content">
                    ${i?`<div class="notification-title">${i}</div>`:""}
                    <div class="notification-message">${e}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `,s.querySelector(".notification-close").addEventListener("click",()=>{this.hide(s)}),this.container.appendChild(s),a>0&&setTimeout(()=>{this.hide(s)},a),s},hide(e){e&&e.parentNode&&(e.style.animation="slideOut 0.3s ease-in forwards",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))},success(e,t="成功"){return this.show(e,"success",5e3,t)},error(e,t="错误"){return this.show(e,"error",7e3,t)},warning(e,t="警告"){return this.show(e,"warning",6e3,t)},info(e,t="提示"){return this.show(e,"info",5e3,t)}}),p(v,"modal",{current:null,show(e,t,a={}){const i=document.getElementById("modal"),s=document.getElementById("modalTitle"),n=document.getElementById("modalBody"),o=document.getElementById("modalSave"),r=document.getElementById("modalCancel");s.textContent=e,n.innerHTML=t,o.textContent=a.saveText||"保存",r.textContent=a.cancelText||"取消",a.saveClass?o.className=`btn ${a.saveClass}`:o.className="btn btn-primary";const l=o.cloneNode(!0),c=r.cloneNode(!0);o.parentNode.replaceChild(l,o),r.parentNode.replaceChild(c,r),a.onSave&&l.addEventListener("click",a.onSave),a.onCancel?c.addEventListener("click",a.onCancel):c.addEventListener("click",()=>this.hide());const d=n.cloneNode(!0);n.parentNode.replaceChild(d,n),d.addEventListener("click",u=>{if(u.target&&(u.target.matches(".image-uploader .btn")||u.target.matches(".audio-uploader .btn"))){const y=u.target.closest(".image-uploader, .audio-uploader");if(y){const h=y.querySelector('input[type="file"]');h&&h.click()}}if(u.target&&u.target.matches(".remove-key-value-item, .remove-key-value-item *")){const y=u.target.closest(".key-value-item");y&&y.remove()}if(u.target&&u.target.matches(".add-key-value-item")){const y=u.target.closest(".key-value-editor");if(y){const h=y.querySelector(".key-value-items"),g=v.formBuilder.createItem();h.appendChild(g)}}}),d.addEventListener("change",async u=>{if(u.target&&u.target.matches('.image-uploader input[type="file"]')){const y=u.target.closest(".image-uploader"),h=u.target.files[0];if(!h||!y)return;const g=y.querySelector(".btn"),m=y.querySelector(".image-preview"),E=y.querySelector('input[type="hidden"]');g.textContent="正在上传...",g.disabled=!0;try{const w=await Utils.imageUtils.compressAndConvertToWebP(h),x=new FormData;x.append("file",w);const C=y.dataset.context;C&&x.append("context",C);const S=await fetch("https://api.zygame1314.site/upload-image",{method:"POST",body:x,headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}),L=await S.json();if(S.ok&&L.success)m.src=L.url,m.classList.remove("no-image"),m.style.display="",E.value=L.url,v.notification.success("图片上传成功");else throw new Error(L.error||"上传失败")}catch(w){v.notification.error(`上传失败: ${w.message}`)}finally{g.textContent="选择图片",g.disabled=!1}}if(u.target&&u.target.matches('.audio-uploader input[type="file"]')){const y=u.target.closest(".audio-uploader"),h=u.target.files[0];if(!h||!y)return;const g=y.querySelector(".upload-status"),m=y.querySelector('input[type="hidden"]'),E=y.querySelector(".btn");if(h.type!=="audio/webm"&&!h.name.toLowerCase().endsWith(".webm")){v.notification.error("文件格式无效","请上传 WebM (.webm) 格式的音频文件。"),u.target.value="";return}g.textContent="正在上传...",E.disabled=!0,E.textContent="上传中...";try{const w=new FormData;w.append("file",h);const x=await fetch("https://api.zygame1314.site/upload-audio",{method:"POST",body:w,headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}),C=await x.json();if(x.ok&&C.success)m.value=C.path,g.textContent=`上传成功: ${C.path}`,v.notification.success("音频上传成功");else throw new Error(C.error||"上传失败")}catch(w){g.textContent=`上传失败: ${w.message}`,v.notification.error(`上传失败: ${w.message}`)}finally{E.disabled=!1,E.textContent="选择文件"}}}),i.classList.add("show"),this.current=i;const f=u=>{u.key==="Escape"&&(this.hide(),document.removeEventListener("keydown",f))};return document.addEventListener("keydown",f),i},hide(){this.current&&(this.current.classList.remove("show"),this.current=null)},confirm(e,t,a,i=null){const s=document.getElementById("confirmModal"),n=document.getElementById("confirmTitle"),o=document.getElementById("confirmMessage"),r=document.getElementById("confirmOk"),l=document.getElementById("confirmCancel");n.textContent=e,o.textContent=t;const c=r.cloneNode(!0),d=l.cloneNode(!0);r.parentNode.replaceChild(c,r),l.parentNode.replaceChild(d,l),c.addEventListener("click",()=>{s.classList.remove("show"),a&&a()}),d.addEventListener("click",()=>{s.classList.remove("show"),i&&i()}),s.classList.add("show")}}),p(v,"table",{create(e,t,a,i={}){const s=document.getElementById(e);if(!s)return null;const n=Utils.domUtils.createElement("table",{className:"data-table"}),o=Utils.domUtils.createElement("thead"),r=Utils.domUtils.createElement("tr");t.forEach(c=>{const d=Utils.domUtils.createElement("th",{textContent:c.title});c.width&&(d.style.width=c.width),r.appendChild(d)}),o.appendChild(r),n.appendChild(o);const l=Utils.domUtils.createElement("tbody");if(a.length===0){const c=Utils.domUtils.createElement("tr"),d=Utils.domUtils.createElement("td",{textContent:i.emptyText||"暂无数据",colspan:t.length.toString()});d.style.textAlign="center",d.style.padding="2rem",d.style.color="var(--text-muted)",c.appendChild(d),l.appendChild(c)}else a.forEach(c=>{const d=Utils.domUtils.createElement("tr");t.forEach(f=>{const u=Utils.domUtils.createElement("td");f.render?u.innerHTML=f.render(c[f.key],c):u.textContent=c[f.key]||"",d.appendChild(u)}),l.appendChild(d)});return n.appendChild(l),s.innerHTML="",s.appendChild(n),n}}),p(v,"pagination",{create(e,t,a,i){const s=document.getElementById(e);if(!s)return null;if(s.innerHTML="",a<=1)return;const n=Utils.domUtils.createElement("div",{className:"pagination"}),o=Utils.domUtils.createElement("button",{className:"pagination-btn",textContent:"上一页"});o.disabled=t<=1,o.addEventListener("click",()=>{t>1&&i(t-1)}),n.appendChild(o);const r=Math.max(1,t-2),l=Math.min(a,t+2);if(r>1){const d=Utils.domUtils.createElement("button",{className:"pagination-btn",textContent:"1"});if(d.addEventListener("click",()=>i(1)),n.appendChild(d),r>2){const f=Utils.domUtils.createElement("span",{textContent:"...",className:"pagination-dots"});n.appendChild(f)}}for(let d=r;d<=l;d++){const f=Utils.domUtils.createElement("button",{className:`pagination-btn ${d===t?"active":""}`,textContent:d.toString()});f.addEventListener("click",()=>i(d)),n.appendChild(f)}if(l<a){if(l<a-1){const f=Utils.domUtils.createElement("span",{textContent:"...",className:"pagination-dots"});n.appendChild(f)}const d=Utils.domUtils.createElement("button",{className:"pagination-btn",textContent:a.toString()});d.addEventListener("click",()=>i(a)),n.appendChild(d)}const c=Utils.domUtils.createElement("button",{className:"pagination-btn",textContent:"下一页"});return c.disabled=t>=a,c.addEventListener("click",()=>{t<a&&i(t+1)}),n.appendChild(c),s.appendChild(n),n}}),p(v,"loading",{show(e,t="加载中..."){const a=document.getElementById(e);if(!a)return null;const i=Utils.domUtils.createElement("div",{className:"loading",textContent:t});return a.innerHTML="",a.appendChild(i),i},hide(e){const t=document.getElementById(e);if(t){const a=t.querySelector(".loading");a&&a.remove()}}}),p(v,"emptyState",{show(e,t={}){const a=document.getElementById(e);if(!a)return null;const i=Utils.domUtils.createElement("div",{className:"empty-state"});return i.innerHTML=`
                <i class="${t.icon||"fas fa-inbox"}"></i>
                <h3>${t.title||"暂无数据"}</h3>
                <p>${t.message||"还没有任何内容"}</p>
                ${t.action?`<button class="btn btn-primary">${t.action.text}</button>`:""}
            `,t.action&&t.action.onClick&&i.querySelector("button").addEventListener("click",t.action.onClick),a.innerHTML="",a.appendChild(i),i}}),p(v,"formBuilder",{create(e){const t=Utils.domUtils.createElement("form");return e.forEach(a=>{if(a.type==="divider"){const n=Utils.domUtils.createElement("div",{className:"form-divider"});n.textContent=a.label||"",n.style.marginTop="2rem",n.style.marginBottom="1rem",n.style.fontWeight="bold",n.style.borderBottom="1px solid var(--border-color)",n.style.paddingBottom="0.5rem",t.appendChild(n);return}const i=Utils.domUtils.createElement("div",{className:`form-group ${a.className||""}`.trim()});if(a.label){const n=Utils.domUtils.createElement("label",{textContent:a.label,for:a.name});a.required&&(n.innerHTML+=' <span style="color: var(--danger-color);">*</span>'),i.appendChild(n)}let s;switch(a.type){case"textarea":s=Utils.domUtils.createElement("textarea",{name:a.name,id:a.name,placeholder:a.placeholder||"",value:a.value||""}),a.rows&&(s.rows=a.rows);break;case"select":s=Utils.domUtils.createElement("select",{name:a.name,id:a.name}),a.options.forEach(l=>{const c=Utils.domUtils.createElement("option",{value:l.value,textContent:l.label});l.value===a.value&&(c.selected=!0),s.appendChild(c)});break;case"image-upload":const n=this.createImageUploader(a);i.appendChild(n);break;case"key-value-editor":const o=this.createKeyValueEditor(a);i.appendChild(o);break;case"audio-upload":const r=this.createAudioUploader(a);i.appendChild(r);break;case"file":s=Utils.domUtils.createElement("input",{type:"file",name:a.name,id:a.name}),a.accept&&(s.accept=a.accept),a.multiple&&(s.multiple=!0);break;case"checkbox":s=Utils.domUtils.createElement("input",{type:"checkbox",name:a.name,id:a.name}),s.checked=a.checked||!1;break;default:s=Utils.domUtils.createElement("input",{type:a.type||"text",name:a.name,id:a.name,placeholder:a.placeholder||"",value:a.value||""});break}if(s&&(a.required&&(s.required=!0),i.appendChild(s)),a.help){const n=Utils.domUtils.createElement("small",{textContent:a.help,className:"form-help"});n.style.color="var(--text-muted)",n.style.fontSize="0.75rem",n.style.marginTop="0.25rem",n.style.display="block",i.appendChild(n)}t.appendChild(i)}),t},createImageUploader(e){const t=Utils.domUtils.createElement("div",{className:"image-uploader"}),a=!!e.value,i=Utils.domUtils.createElement("img",{src:e.value||"",alt:"图片预览",className:`image-preview ${a?"":"no-image"}`});a||(i.style.display="none");const s=Utils.domUtils.createElement("input",{type:"file",accept:"image/*",style:"display: none;"}),n=Utils.domUtils.createElement("button",{type:"button",textContent:"选择图片",className:"btn btn-secondary"}),o=Utils.domUtils.createElement("input",{type:"hidden",name:e.name,value:e.value||""});return e.uploadContext&&(t.dataset.context=e.uploadContext),t.appendChild(i),t.appendChild(n),t.appendChild(s),t.appendChild(o),t},createKeyValueEditor(e){const t=Utils.domUtils.createElement("div",{className:"key-value-editor","data-name":e.name}),a=Utils.domUtils.createElement("div",{className:"key-value-items"}),i=Utils.domUtils.createElement("button",{type:"button",textContent:"添加操作",className:"btn btn-secondary btn-sm add-key-value-item"}),s=(o={})=>{const r=Utils.domUtils.createElement("div",{className:"key-value-item"});return r.innerHTML=`
                    <div class="key-value-inputs">
                        <input type="text" class="form-control" data-key="text" placeholder="按钮文字" value="${o.text||""}">
                        <input type="text" class="form-control" data-key="url" placeholder="URL" value="${o.url||""}">
                        <select class="form-control" data-key="type">
                            <option value="primary" ${o.type==="primary"?"selected":""}>主按钮</option>
                            <option value="secondary" ${o.type==="secondary"?"selected":""}>次按钮</option>
                            <option value="external" ${o.type==="external"?"selected":""}>外部链接</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-key-value-item">
                        <i class="fas fa-trash"></i>
                    </button>
                `,r},n=e.value?typeof e.value=="string"?JSON.parse(e.value):e.value:[];return Array.isArray(n)&&n.length>0?n.forEach(o=>a.appendChild(s(o))):a.appendChild(s()),t.appendChild(a),t.appendChild(i),t},createItem(e={}){const t=Utils.domUtils.createElement("div",{className:"key-value-item"});return t.innerHTML=`
                <div class="key-value-inputs">
                    <input type="text" class="form-control" data-key="text" placeholder="按钮文字" value="${e.text||""}">
                    <input type="text" class="form-control" data-key="url" placeholder="URL" value="${e.url||""}">
                    <select class="form-control" data-key="type">
                        <option value="primary" ${e.type==="primary"?"selected":""}>主按钮</option>
                        <option value="secondary" ${e.type==="secondary"?"selected":""}>次按钮</option>
                        <option value="external" ${e.type==="external"?"selected":""}>外部链接</option>
                    </select>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-key-value-item">
                    <i class="fas fa-trash"></i>
                </button>
            `,t},createAudioUploader(e){const t=Utils.domUtils.createElement("div",{className:"audio-uploader"}),a=Utils.domUtils.createElement("input",{type:"file",accept:"audio/webm",style:"display: none;"}),i=Utils.domUtils.createElement("button",{type:"button",textContent:"选择文件",className:"btn btn-secondary"}),s=Utils.domUtils.createElement("div",{className:"upload-status"});s.textContent=e.value?`当前文件: ${e.value}`:"未选择文件",s.style.marginTop="0.5rem",s.style.fontSize="0.8rem",s.style.color="var(--text-muted)";const n=Utils.domUtils.createElement("input",{type:"hidden",name:e.name,value:e.value||""});return t.appendChild(i),t.appendChild(a),t.appendChild(s),t.appendChild(n),t},getFormData(e){const t=new FormData(e),a={};for(let[i,s]of t.entries())a[i]=s;return e.querySelectorAll(".image-uploader, .audio-uploader").forEach(i=>{const s=i.querySelector('input[type="hidden"]');s&&(a[s.name]=s.value)}),e.querySelectorAll(".key-value-editor").forEach(i=>{const s=i.dataset.name,n=[];i.querySelectorAll(".key-value-item").forEach(o=>{const r=o.querySelector('[data-key="text"]').value,l=o.querySelector('[data-key="url"]').value,c=o.querySelector('[data-key="type"]').value;r&&l&&n.push({text:r,url:l,type:c})}),a[s]=JSON.stringify(n)}),a},setFormData(e,t){Object.keys(t).forEach(a=>{const i=e.querySelector(`[name="${a}"]`);i&&(i.type==="checkbox"||i.type==="radio"?i.checked=t[a]:i.value=t[a]||"")})},validate(e,t){const a=this.getFormData(e),i={};let s=!0;return Object.keys(t).forEach(n=>{const o=e.querySelector(`[name="${n}"]`),r=a[n],l=t[n],c=Utils.validation.validateField(r,l);if(c.isValid){o.style.borderColor="";const d=o.parentNode.querySelector(".field-error");d&&d.remove()}else{i[n]=c.errors,s=!1,o.style.borderColor="var(--danger-color)";const d=o.parentNode.querySelector(".field-error");d&&d.remove();const f=Utils.domUtils.createElement("div",{className:"field-error",textContent:c.errors[0]});f.style.color="var(--danger-color)",f.style.fontSize="0.75rem",f.style.marginTop="0.25rem",o.parentNode.appendChild(f)}}),{isValid:s,errors:i,data:a}}}),p(v,"card",{create(e={}){const t=Utils.domUtils.createElement("div",{className:`card ${e.className||""}`});if(e.header){const a=Utils.domUtils.createElement("div",{className:"card-header"});typeof e.header=="string"?a.innerHTML=e.header:a.appendChild(e.header),t.appendChild(a)}if(e.body){const a=Utils.domUtils.createElement("div",{className:"card-body"});typeof e.body=="string"?a.innerHTML=e.body:a.appendChild(e.body),t.appendChild(a)}if(e.footer){const a=Utils.domUtils.createElement("div",{className:"card-footer"});typeof e.footer=="string"?a.innerHTML=e.footer:a.appendChild(e.footer),t.appendChild(a)}return t}}),v);document.addEventListener("DOMContentLoaded",()=>{N.notification.init()});const D=document.createElement("style");D.textContent=`
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .pagination-dots {
        padding: 0.5rem 0.75rem;
        color: var(--text-muted);
    }
    
    .field-error {
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .key-value-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }

    .key-value-inputs {
        display: flex;
        flex-grow: 1;
        gap: 0.5rem;
    }

    .key-value-inputs .form-control {
        flex: 1;
    }
    .image-preview.no-image {
        display: none;
    }
`;document.head.appendChild(D);window.Components=N;class q{constructor(){this.currentSection="dashboard",this.cache=new Map,this.searchHandlers=new Map,this.filterHandlers=new Map,this.donationsCache=[],this.musicCache=[],this.projectsCache=[],this.noticesCache=[],this.timelineCache=[],this.init()}async init(){await this.checkAuth(),this.setupEventListeners(),this.removeDuplicateNavItems(),this.setupNavigation(),this.setupModals(),this.loadDashboard()}async checkAuth(){const e=localStorage.getItem("authToken");if(!e){window.location.href="login.html";return}try{const t=await fetch("https://api.zygame1314.site/auth",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Token validation failed");const a=await t.json();if(!a.success)throw new Error(a.error||"Invalid token");console.log("Authentication successful for user:",a.user)}catch{localStorage.removeItem("authToken"),window.location.href="login.html"}}setupEventListeners(){var s;const e=document.getElementById("sidebarToggle"),t=document.getElementById("mobileSidebarToggle"),a=document.querySelector(".sidebar"),i=document.querySelector(".sidebar-overlay");e==null||e.addEventListener("click",()=>{a.classList.toggle("collapsed"),document.querySelector(".main-content").classList.toggle("collapsed")}),t==null||t.addEventListener("click",()=>{a.classList.toggle("show"),i.classList.toggle("show")}),i==null||i.addEventListener("click",()=>{a.classList.remove("show"),i.classList.remove("show")}),document.querySelectorAll(".nav-link").forEach(n=>{n.addEventListener("click",o=>{o.preventDefault();const r=n.dataset.section;r&&this.navigateToSection(r)})}),document.querySelectorAll(".view-all-btn").forEach(n=>{n.addEventListener("click",o=>{o.preventDefault();const r=n.dataset.section;r&&this.navigateToSection(r)})}),document.querySelectorAll(".quick-action-btn").forEach(n=>{n.addEventListener("click",o=>{const r=n.getAttribute("title");r==="刷新数据"?this.refreshCurrentSection():r==="返回主站"&&window.open("/","_blank")})}),(s=document.getElementById("logoutBtn"))==null||s.addEventListener("click",()=>{Components.modal.confirm("确认退出","确定要退出管理系统吗？",()=>{localStorage.removeItem("authToken"),window.location.href="login.html"})})}removeDuplicateNavItems(){const e=document.querySelectorAll(".sidebar .nav-link"),t=new Set;e.forEach(a=>{const i=a.dataset.section;i&&(t.has(i)?a.parentElement.remove():t.add(i))})}setupNavigation(){this.updateBreadcrumb("仪表盘")}setupModals(){document.querySelectorAll(".modal-close").forEach(e=>{e.addEventListener("click",()=>{Components.modal.hide()})}),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&Components.modal.hide()})})}navigateToSection(e){var a;document.querySelectorAll(".nav-item").forEach(i=>{i.classList.remove("active")}),(a=document.querySelector(`[data-section="${e}"]`))==null||a.parentElement.classList.add("active"),document.querySelectorAll(".content-section").forEach(i=>{i.classList.remove("active")});const t=document.getElementById(`${e}-section`);t&&(t.classList.add("active"),this.currentSection=e,this.updateBreadcrumb(this.getSectionTitle(e)),this.loadSectionData(e))}getSectionTitle(e){return{dashboard:"仪表盘",donations:"捐献管理",music:"音乐管理",projects:"项目管理",notices:"公告管理",timeline:"时间线管理","important-notices":"重要公告管理",articles:"文章管理"}[e]||e}updateBreadcrumb(e){const t=document.querySelector(".breadcrumb-item");t&&(t.textContent=e)}async loadSectionData(e){switch(e){case"dashboard":await this.loadDashboard();break;case"donations":await this.loadDonations();break;case"music":await this.loadMusic();break;case"projects":await this.loadProjects();break;case"notices":await this.loadNotices();break;case"timeline":await this.loadTimeline();break;case"articles":await this.loadArticles();break;case"important-notices":await this.loadImportantNotices();break}}refreshCurrentSection(){this.cache.clear(),this.loadSectionData(this.currentSection),Components.notification.success("数据已刷新")}async loadDashboard(){try{const e=await api.getStatistics();this.updateStatistics(e);const t=await api.donations.getList(1,5);this.updateRecentDonations(t.data||[])}catch(e){Components.notification.error("加载仪表盘数据失败"),console.error("Dashboard load error:",e)}}updateStatistics(e){document.getElementById("total-donations").textContent=e.totalDonations,document.getElementById("total-songs").textContent=e.totalSongs,document.getElementById("total-projects").textContent=e.totalProjects,document.getElementById("total-notices").textContent=e.totalNotices}updateRecentDonations(e){const t=document.getElementById("recent-donations");if(t){if(e.length===0){t.innerHTML='<div class="empty-state">暂无捐献记录</div>';return}t.innerHTML="",e.forEach(a=>{const i=Utils.domUtils.createElement("div",{className:"data-item"});i.innerHTML=`
                <div class="data-item-info">
                    <div class="data-item-title">${a.name||"匿名"}</div>
                    <div class="data-item-meta">${Utils.formatDate(a.date)} · ${a.platform}</div>
                </div>
                <div class="data-item-value">¥${Utils.formatMoney(a.amount)}</div>
            `,t.appendChild(i)})}}async loadDonations(e=null){const t=parseInt(Utils.getUrlParam("donation_page"))||1,a=e===null?Utils.getUrlParam("platform")||"":e;try{Components.loading.show("donationsTableBody","加载捐献数据...");const i=await api.donations.getList(t,10,a||null);this.renderDonationsTable(i.data||[]),i.pagination&&Components.pagination.create("donationsPagination",i.pagination.page,i.pagination.totalPages,s=>{Utils.setUrlParam("donation_page",s),this.loadDonations(a)}),this.setupDonationActions()}catch(i){Components.notification.error("加载捐献数据失败"),console.error("Donations load error:",i)}}renderDonationsTable(e){const t=[{key:"name",title:"捐献者"},{key:"amount",title:"金额",render:i=>`¥${Utils.formatMoney(i)}`},{key:"platform",title:"平台"},{key:"date",title:"日期",render:i=>Utils.formatDate(i,"YYYY-MM-DD HH:mm")},{key:"message",title:"留言",render:i=>Utils.truncateText(i||"无",50)},{key:"actions",title:"操作",render:(i,s)=>`
                    <div class="action-buttons">
                        <button class="action-btn edit" title="编辑" data-id="${s.id||""}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" title="删除" data-id="${s.id||""}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `}];this.cache.set("donations-current",e);const a=document.getElementById("donationsTableBody");if(a)if(a.innerHTML="",e.length===0){const i=Utils.domUtils.createElement("tr"),s=Utils.domUtils.createElement("td",{textContent:"暂无捐献记录",colspan:t.length.toString()});s.style.textAlign="center",s.style.padding="2rem",s.style.color="var(--text-muted)",i.appendChild(s),a.appendChild(i)}else e.forEach(i=>{const s=Utils.domUtils.createElement("tr");t.forEach(n=>{const o=Utils.domUtils.createElement("td");n.render?o.innerHTML=n.render(i[n.key],i):o.textContent=i[n.key]||"",s.appendChild(o)}),a.appendChild(s)})}setupDonationActions(){var a;(a=document.getElementById("addDonationBtn"))==null||a.addEventListener("click",()=>{this.showDonationForm()});const e=document.getElementById("donationSearch");if(e&&!this.searchHandlers.has("donation")){const i=Utils.debounce(async s=>{const n=s.target.value.trim();n?await this.searchDonations(n):await this.loadDonations()},500);e.addEventListener("input",i),this.searchHandlers.set("donation",i)}const t=document.getElementById("platformFilter");if(t&&!this.filterHandlers.has("donation_platform")){const i=async s=>{const n=s.target.value;await this.filterDonationsByPlatform(n)};t.addEventListener("change",i),this.filterHandlers.set("donation_platform",i)}document.querySelectorAll(".action-btn").forEach(i=>{i.addEventListener("click",s=>{s.stopPropagation();const n=i.dataset.id;i.classList.contains("edit")?this.editDonation(n):i.classList.contains("delete")&&this.deleteDonation(n)})})}showDonationForm(e=null){const t=!!e,a=t?"编辑捐献记录":"添加捐献记录",i=[{name:"name",label:"捐献者姓名",type:"text",required:!0,value:(e==null?void 0:e.name)||"",placeholder:"请输入捐献者姓名"},{name:"amount",label:"捐献金额",type:"number",required:!0,value:(e==null?void 0:e.amount)||"",placeholder:"0.00"},{name:"platform",label:"支付平台",type:"select",required:!0,value:(e==null?void 0:e.platform)||"",options:[{value:"",label:"请选择平台"},{value:"alipay",label:"支付宝"},{value:"wechat",label:"微信支付"}]},{name:"date",label:"捐献日期",type:"datetime-local",required:!0,value:e?Utils.formatDate(e.date,"YYYY-MM-DD HH:mm").replace(" ","T"):""},{name:"message",label:"留言",type:"textarea",value:(e==null?void 0:e.message)||"",placeholder:"可选的留言内容",rows:3}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const n=document.querySelector("#modal form"),o={name:[Utils.validation.rules.required],amount:[Utils.validation.rules.required,Utils.validation.rules.positiveNumber],platform:[Utils.validation.rules.required],date:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{t?await api.donations.update({id:e.id,...r.data}):await api.donations.add(r.data),Components.modal.hide(),Components.notification.success(t?"捐献记录已更新":"捐献记录已添加"),await this.loadDonations()}catch(l){Components.notification.error("保存失败："+l.message)}}}),t&&(e!=null&&e.message)){const n=document.querySelector('#modal textarea[name="message"]');n&&(n.value=e.message)}}editDonation(e){const t=this.cache.get("donations-current");if(t){const a=t.find(i=>i.id==e);if(a){this.showDonationForm(a);return}}Components.notification.warning("未找到要编辑的记录")}deleteDonation(e){Components.modal.confirm("确认删除","确定要删除这条捐献记录吗？此操作不可撤销。",async()=>{try{await api.donations.delete(e),Components.notification.success("捐献记录已删除"),await this.loadDonations()}catch(t){Components.notification.error("删除失败："+t.message)}})}async searchDonations(e){try{const t=await api.search(e,"donations");this.renderDonationsTable(t.donations)}catch(t){Components.notification.error("搜索失败"),console.error("Search error:",t)}}async filterDonationsByPlatform(e){Utils.setUrlParam("donation_page",1),e?Utils.setUrlParam("platform",e):Utils.removeUrlParam("platform"),await this.loadDonations(e)}async loadMusic(){try{Components.loading.show("musicGrid","加载音乐数据...");const t=(await api.music.getPlaylist()).songs||[];this.cache.set("music",t),this.renderMusicGrid(t),this.setupMusicActions()}catch(e){Components.notification.error("加载音乐数据失败"),console.error("Music load error:",e)}}renderMusicGrid(e){const t=document.getElementById("musicGrid");if(t){if(e.length===0){Components.emptyState.show("musicGrid",{icon:"fas fa-music",title:"暂无音乐",message:"还没有添加任何音乐",action:{text:"添加音乐",onClick:()=>this.showMusicForm()}});return}t.innerHTML="",e.forEach(a=>{const i=Utils.domUtils.createElement("div",{className:"music-card"});i.innerHTML=`
                <div class="music-cover" style="background-image: url('${a.cover||"https://bucket.zygame1314.site/static/images/default-music.jpg"}')">
                    <div class="music-overlay">
                        <button class="play-btn" title="播放" data-path="${a.path}">
                            <span class="play-icon"></span>
                        </button>
                    </div>
                </div>
                <div class="music-info">
                    <div class="music-title">${a.title}</div>
                    <div class="music-artist">${a.artist}</div>
                    ${a.ytLink?`<a href="${a.ytLink}" target="_blank" class="yt-link">YouTube</a>`:""}
                    <div class="music-actions">
                        <button class="btn btn-sm edit-music" data-id="${a.id}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger delete-music" data-id="${a.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `,t.appendChild(i)})}}setupMusicActions(){var t;(t=document.getElementById("addMusicBtn"))==null||t.addEventListener("click",()=>{this.showMusicForm()});const e=document.getElementById("musicSearch");if(e&&!this.searchHandlers.has("music")){const a=Utils.debounce(async i=>{const s=i.target.value.trim();s?await this.searchMusic(s):await this.loadMusic()},500);e.addEventListener("input",a),this.searchHandlers.set("music",a)}document.querySelectorAll(".play-btn").forEach(a=>{a.addEventListener("click",i=>{const s=i.currentTarget.dataset.path;this.playMusic(s,i.currentTarget)})}),document.querySelectorAll(".edit-music").forEach(a=>{a.addEventListener("click",i=>{const s=i.currentTarget.dataset.id,n=this.cache.get("music");if(n){const o=n.find(r=>r.id==s);o?this.showMusicForm(o):Components.notification.error("在缓存中找不到该音乐。")}else Components.notification.error("音乐缓存未找到，请尝试刷新页面。")})}),document.querySelectorAll(".delete-music").forEach(a=>{a.addEventListener("click",i=>{const s=a.dataset.id;this.deleteMusic(s)})})}showMusicForm(e=null){const t=!!e,a=t?"编辑音乐":"添加音乐",i=[{name:"title",label:"歌曲标题",type:"text",required:!0,value:(e==null?void 0:e.title)||"",placeholder:"请输入歌曲标题"},{name:"artist",label:"艺术家",type:"text",required:!0,value:(e==null?void 0:e.artist)||"",placeholder:"请输入艺术家名称"},{name:"path",label:"音频文件",type:"audio-upload",required:!0,value:(e==null?void 0:e.path)||"",help:"上传或修改音频文件。"},{name:"cover",label:"封面图片",type:"image-upload",value:(e==null?void 0:e.cover)||"",uploadContext:"music"},{name:"ytLink",label:"YouTube 链接",type:"url",value:(e==null?void 0:e.ytLink)||"",placeholder:"https://youtube.com/watch?v=..."},{name:"comment",label:"备注",type:"textarea",value:(e==null?void 0:e.comment)||"",placeholder:"可选的备注信息",rows:2},{name:"expression",label:"表情",type:"select",value:(e==null?void 0:e.expression)||"",options:[{value:"",label:"无表情"},{value:"Exp1",label:"恼怒"},{value:"Exp2",label:"无语"},{value:"Exp3",label:"惊讶"},{value:"Exp4",label:"困惑"},{value:"Exp5",label:"墨镜"},{value:"Exp6",label:"袋子"},{value:"Exp7",label:"眩晕"},{value:"Exp8",label:"星星眼"},{value:"TongueOut",label:"吐舌头"},{value:"HighlightOFF",label:"失去高光"}],help:"选择一个在播放此音乐时触发的Live2D表情。"}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const n=document.querySelector("#modal form"),o={title:[Utils.validation.rules.required],artist:[Utils.validation.rules.required],path:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{t?await api.music.update({id:e.id,...r.data}):await api.music.add(r.data),Components.modal.hide(),Components.notification.success(t?"音乐已更新":"音乐已添加"),await this.loadMusic()}catch(l){Components.notification.error("保存失败："+l.message)}}}),t){if(e.comment){const n=document.querySelector('#modal textarea[name="comment"]');n&&(n.value=e.comment)}if(e.expression){const n=document.querySelector('#modal select[name="expression"]');n&&(n.value=e.expression)}}}deleteMusic(e){Components.modal.confirm("确认删除","确定要删除这首音乐吗？此操作不可撤销。",async()=>{try{await api.music.delete(e),Components.notification.success("音乐已删除"),await this.loadMusic()}catch(t){Components.notification.error("删除失败："+t.message)}})}async searchMusic(e){try{const t=await api.search(e,"music");this.renderMusicGrid(t.music)}catch(t){Components.notification.error("搜索失败"),console.error("Search error:",t)}}playMusic(e,t){let a=window.audioPlayer;a||(a=new Audio,window.audioPlayer=a);const i=document.querySelectorAll(".play-btn"),s=t.classList.contains("playing");i.forEach(n=>{n.classList.remove("playing"),n.querySelector(".play-icon").classList.remove("paused")}),s?a.pause():(a.src=e,a.play(),t.classList.add("playing"),t.querySelector(".play-icon").classList.add("paused"),a.onended=()=>{t.classList.remove("playing"),t.querySelector(".play-icon").classList.remove("paused")})}async loadProjects(){try{Components.loading.show("projectsGrid","加载项目数据...");const t=(await api.projects.getList(1,50)).projects||[];this.cache.set("projects",t),this.renderProjectsGrid(t),this.setupProjectActions()}catch(e){Components.notification.error("加载项目数据失败"),console.error("Projects load error:",e)}}renderProjectsGrid(e){const t=document.getElementById("projectsGrid");if(t){if(e.length===0){Components.emptyState.show("projectsGrid",{icon:"fas fa-code",title:"暂无项目",message:"还没有添加任何项目",action:{text:"添加项目",onClick:()=>this.showProjectForm()}});return}t.innerHTML="",e.forEach(a=>{const i=Utils.domUtils.createElement("div",{className:"project-card"});i.innerHTML=`
                <div class="project-image" style="background-image: url('${a.imageUrl||"https://bucket.zygame1314.site/static/images/default-project.jpg"}')"></div>
                <div class="project-content">
                    <div class="project-title">${a.title}</div>
                    <div class="project-description">${a.description||"暂无描述"}</div>
                    <div class="project-type">${a.type||"normal"}</div>
                    <div class="project-actions">
                        <button class="btn btn-sm edit-project" data-id="${a.id}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger delete-project" data-id="${a.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                        ${(a.actions||[]).map(s=>`<a href="${s.url}" target="_blank" class="btn btn-sm">${s.text}</a>`).join("")}
                        ${a.githubUrl?`<a href="${a.githubUrl}" target="_blank" class="btn btn-sm">
                            <i class="fab fa-github"></i> GitHub
                        </a>`:""}
                    </div>
                </div>
            `,t.appendChild(i)})}}setupProjectActions(){var e;(e=document.getElementById("addProjectBtn"))==null||e.addEventListener("click",()=>{this.showProjectForm()}),document.querySelectorAll(".edit-project").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id,s=this.cache.get("projects");if(s){const n=s.find(o=>o.id==i);n?this.showProjectForm(n):Components.notification.error("在缓存中找不到该项目。")}else Components.notification.error("项目缓存未找到，请尝试刷新页面。")})}),document.querySelectorAll(".delete-project").forEach(t=>{t.addEventListener("click",a=>{const i=t.dataset.id;this.deleteProject(i)})})}showProjectForm(e=null){const t=!!e,a=t?"编辑项目":"添加项目",i=[{name:"id",label:"项目ID",type:"text",required:!0,value:(e==null?void 0:e.id)||"",placeholder:"项目唯一标识符"},{name:"title",label:"项目标题",type:"text",required:!0,value:(e==null?void 0:e.title)||"",placeholder:"请输入项目标题"},{name:"description",label:"项目描述",type:"textarea",required:!0,value:(e==null?void 0:e.description)||"",placeholder:"请输入项目描述",rows:3},{name:"imageUrl",label:"项目图片",type:"image-upload",value:(e==null?void 0:e.imageUrl)||"",uploadContext:"projects"},{name:"githubUrl",label:"GitHub URL",type:"url",value:(e==null?void 0:e.githubUrl)||"",placeholder:"https://github.com/username/repo"},{name:"type",label:"项目类型",type:"select",value:(e==null?void 0:e.type)||"normal",options:[{value:"normal",label:"普通项目"},{value:"featured",label:"特色项目"},{value:"open-source",label:"开源项目"},{value:"commercial",label:"商业项目"}]},{name:"actions",label:"操作按钮",type:"key-value-editor",value:(e==null?void 0:e.actions)||[]}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const n=document.querySelector("#modal form"),o={id:[Utils.validation.rules.required],title:[Utils.validation.rules.required],description:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{const l=r.data;if(l.actions)try{const c=JSON.parse(l.actions);if(!Array.isArray(c)||c.length===0){Components.notification.error("必须至少包含一个操作按钮。");return}l.actions=c}catch{Components.notification.error("操作按钮数据格式无效。");return}else l.actions=[];t?await api.projects.update(l):await api.projects.add(l),Components.modal.hide(),Components.notification.success(t?"项目已更新":"项目已添加"),await this.loadProjects()}catch(l){Components.notification.error("保存失败："+l.message)}}}),t&&(e!=null&&e.description)){const n=document.querySelector('#modal textarea[name="description"]');n&&(n.value=e.description)}}deleteProject(e){Components.modal.confirm("确认删除","确定要删除这个项目吗？此操作不可撤销。",async()=>{try{await api.projects.delete(e),Components.notification.success("项目已删除"),await this.loadProjects()}catch(t){Components.notification.error("删除失败："+t.message)}})}async loadNotices(){try{Components.loading.show("noticesList","加载公告数据...");const t=(await api.notices.getList()).notices||[];this.cache.set("notices",t),this.renderNoticesList(t),this.setupNoticeActions()}catch(e){Components.notification.error("加载公告数据失败"),console.error("Notices load error:",e)}}renderNoticesList(e){const t=document.getElementById("noticesList");if(t){if(e.length===0){Components.emptyState.show("noticesList",{icon:"fas fa-bullhorn",title:"暂无公告",message:"还没有发布任何公告",action:{text:"添加公告",onClick:()=>this.showNoticeForm()}});return}t.innerHTML="",e.forEach((a,i)=>{const s=Utils.domUtils.createElement("div",{className:"notice-item"});s.innerHTML=`
                <div class="notice-header">
                    <i class="notice-icon ${a.icon||"fas fa-info-circle"}"></i>
                    <div class="notice-title">${a.title}</div>
                    <div class="notice-actions">
                        <button class="action-btn edit edit-notice" title="编辑" data-id="${a.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete delete-notice" title="删除" data-id="${a.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="notice-content">
                    ${Array.isArray(a.content)?a.content.map(n=>{const o=n.description?`<p class="notice-description">${n.description}</p>`:"",r=n.highlight?"highlight":"";return`
                                <div class="notice-detail-item ${n.type||"info"} ${r}">
                                    ${n.icon?`<i class="notice-detail-icon ${n.icon}"></i>`:""}
                                    <div class="notice-detail-text">
                                        <strong>${n.text||""}</strong>
                                        ${o}
                                    </div>
                                </div>
                            `}).join(""):a.content}
                </div>
            `,t.appendChild(s)})}}setupNoticeActions(){var e;(e=document.getElementById("addNoticeBtn"))==null||e.addEventListener("click",()=>{this.showNoticeForm()}),document.querySelectorAll(".edit-notice").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id,s=this.cache.get("notices");if(s){const n=s.find(o=>o.id==i);n?this.showNoticeForm(n):Components.notification.error("在缓存中找不到该公告。")}else Components.notification.error("公告缓存未找到，请尝试刷新页面。")})}),document.querySelectorAll(".delete-notice").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id;this.deleteNotice(i)})})}showNoticeForm(e=null){const t=!!e,a=t?"编辑公告":"添加公告",i=[{name:"title",label:"公告标题",type:"text",required:!0,value:(e==null?void 0:e.title)||"",placeholder:"请输入公告标题"},{name:"icon",label:"图标类名",type:"text",value:(e==null?void 0:e.icon)||"fas fa-info-circle",placeholder:"fas fa-info-circle",help:"使用 FontAwesome 图标类名"},{name:"content",label:"公告内容",type:"textarea",required:!0,value:"",placeholder:"请输入公告内容，每行一段",rows:5,help:"每行内容将作为一段显示"}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const n=document.querySelector("#modal form"),o={title:[Utils.validation.rules.required],content:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{let l;try{l=JSON.parse(r.data.content)}catch{Components.notification.error("公告内容不是有效的JSON格式。");return}const c={title:r.data.title,icon:r.data.icon,content:l};t?await api.notices.update({id:e.id,...c}):await api.notices.add(c),Components.modal.hide(),Components.notification.success(t?"公告已更新":"公告已添加"),await this.loadNotices()}catch(l){Components.notification.error("保存失败："+l.message)}}}),t&&(e!=null&&e.content)){const n=document.querySelector('#modal textarea[name="content"]');n&&(n.value=JSON.stringify(e.content,null,2))}}deleteNotice(e){Components.modal.confirm("确认删除","确定要删除这条公告吗？此操作不可撤销。",async()=>{try{await api.notices.delete(e),Components.notification.success("公告已删除"),await this.loadNotices()}catch(t){Components.notification.error("删除失败："+t.message)}})}async loadTimeline(){try{Components.loading.show("timelineContainer","加载时间线数据...");const t=(await api.timeline.getList(1,50)).milestones||[];this.cache.set("timeline",t),this.renderTimeline(t),this.setupTimelineActions()}catch(e){Components.notification.error("加载时间线数据失败"),console.error("Timeline load error:",e)}}renderTimeline(e){const t=document.getElementById("timelineContainer");if(t){if(e.length===0){Components.emptyState.show("timelineContainer",{icon:"fas fa-history",title:"暂无时间线",message:"还没有添加任何时间节点",action:{text:"添加时间节点",onClick:()=>this.showTimelineForm()}});return}t.innerHTML="",e.forEach((a,i)=>{const s=Utils.domUtils.createElement("div",{className:"timeline-item"});s.innerHTML=`
                <div class="timeline-content">
                    <div class="timeline-date">${Utils.formatDate(a.date)}</div>
                    <div class="timeline-title">${a.title}</div>
                    <div class="timeline-description">${a.description}</div>
                    <div class="timeline-actions" style="margin-top: 1rem;">
                        <button class="btn btn-sm edit-timeline" data-id="${a.id}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger delete-timeline" data-id="${a.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `,t.appendChild(s)})}}setupTimelineActions(){var e;(e=document.getElementById("addTimelineBtn"))==null||e.addEventListener("click",()=>{this.showTimelineForm()}),document.querySelectorAll(".edit-timeline").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id,s=this.cache.get("timeline");if(s){const n=s.find(o=>o.id==i);n?this.showTimelineForm(n):Components.notification.error("在缓存中找不到该时间节点。")}else Components.notification.error("时间线缓存未找到，请尝试刷新页面。")})}),document.querySelectorAll(".delete-timeline").forEach(t=>{t.addEventListener("click",a=>{const i=t.dataset.id;this.deleteTimeline(i)})})}showTimelineForm(e=null){const t=!!e,a=t?"编辑时间节点":"添加时间节点",i=[{name:"date",label:"日期",type:"date",required:!0,value:e?Utils.formatDate(e.date):"",placeholder:"选择日期"},{name:"title",label:"标题",type:"text",required:!0,value:(e==null?void 0:e.title)||"",placeholder:"请输入时间节点标题"},{name:"description",label:"描述",type:"textarea",required:!0,value:"",placeholder:"请输入详细描述",rows:3}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const n=document.querySelector("#modal form"),o={date:[Utils.validation.rules.required],title:[Utils.validation.rules.required],description:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{t?await api.timeline.update({id:e.id,...r.data}):await api.timeline.add(r.data),Components.modal.hide(),Components.notification.success(t?"时间节点已更新":"时间节点已添加"),await this.loadTimeline()}catch(l){Components.notification.error("保存失败："+l.message)}}}),t&&(e!=null&&e.description)){const n=document.querySelector('#modal textarea[name="description"]');n&&(n.value=e.description)}}deleteTimeline(e){Components.modal.confirm("确认删除","确定要删除这个时间节点吗？此操作不可撤销。",async()=>{try{await api.timeline.delete(e),Components.notification.success("时间节点已删除"),await this.loadTimeline()}catch(t){Components.notification.error("删除失败："+t.message)}})}async loadArticles(){const e=parseInt(Utils.getUrlParam("article_page"))||1;try{Components.loading.show("articlesGrid","加载文章数据...");const t=await api.articles.getList(e,10),a=t.data||[];this.cache.set("articles",a),this.renderArticlesGrid(a),t.pagination&&Components.pagination.create("articlesPagination",t.pagination.page,t.pagination.totalPages,i=>{Utils.setUrlParam("article_page",i),this.loadArticles()}),this.setupArticleActions()}catch(t){Components.notification.error("加载文章数据失败"),console.error("Articles load error:",t)}}renderArticlesGrid(e){const t=document.getElementById("articlesGrid");if(t){if(e.length===0){Components.emptyState.show("articlesGrid",{icon:"fas fa-book",title:"暂无文章",message:"还没有发布任何文章",action:{text:"添加文章",onClick:()=>this.showArticleForm()}});return}t.innerHTML="",e.forEach(a=>{const i=Utils.domUtils.createElement("div",{className:"article-card"});i.innerHTML=`
                ${a.thumbnail?`<div class="article-thumbnail" style="background-image: url('${a.thumbnail}')"></div>`:""}
                <div class="article-content">
                    <div class="article-title">${a.title}</div>
                    <div class="article-excerpt">${a.excerpt||"暂无摘要"}</div>
                    <div class="article-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${Utils.formatDate(a.date)}</span>
                        ${a.tags?`<span><i class="fas fa-tags"></i> ${a.tags}</span>`:""}
                    </div>
                    <div class="article-actions">
                        <button class="btn btn-sm edit-article" data-id="${a.id}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger delete-article" data-id="${a.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `,t.appendChild(i)})}}async loadImportantNotices(){try{Components.loading.show("importantNoticesList","加载重要公告...");const t=(await api.importantNotices.getList()).notices||[];this.cache.set("important-notices",t),this.renderImportantNotices(t),this.setupImportantNoticeActions()}catch(e){Components.notification.error("加载重要公告失败: "+e.message)}}renderImportantNotices(e){const t=document.getElementById("importantNoticesList");if(t){if(e.length===0){Components.emptyState.show("importantNoticesList",{icon:"fas fa-exclamation-triangle",title:"无重要公告",message:"当前没有正在生效的重要公告。",action:{text:"添加公告",onClick:()=>this.showImportantNoticeForm()}});return}t.innerHTML="",e.forEach(a=>{const i=Utils.domUtils.createElement("div",{className:"notice-item"}),s=a.active?"online":"offline",n=a.active?"生效中":"已禁用";let o="";a.image&&a.image.url&&(o=`
                        <div class="notice-image-container">
                            <img src="${a.image.url}" alt="${a.image.alt||"公告图片"}" style="max-width: 100%; height: auto; margin-top: 1rem;">
                        </div>
                    `);let r="";a.poll&&a.poll.active&&(r=`
                        <div class="notice-poll-container" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <strong>投票: ${a.poll.question}</strong>
                            <ul>
                                ${a.poll.options.map(l=>`<li>${l.text}</li>`).join("")}
                            </ul>
                        </div>
                    `),i.innerHTML=`
                    <div class="notice-header">
                        <div class="notice-title">${a.title}</div>
                        <div class="notice-actions">
                            <span class="status-value ${s}">${n}</span>
                            <button class="action-btn edit-important-notice" title="编辑" data-id="${a.id}"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-important-notice" title="删除" data-id="${a.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="notice-content">
                        <p>${a.content}</p>
                        ${o}
                        ${r}
                        <small style="display: block; margin-top: 1rem; opacity: 0.7;">过期时间: ${a.expiryDate?Utils.formatDate(a.expiryDate):"无"}</small>
                    </div>
                `,t.appendChild(i)})}}setupImportantNoticeActions(){var e;(e=document.getElementById("addImportantNoticeBtn"))==null||e.addEventListener("click",()=>{this.showImportantNoticeForm()}),document.querySelectorAll(".edit-important-notice").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id,s=this.cache.get("important-notices");if(s){const n=s.find(o=>o.id==i);n?this.showImportantNoticeForm(n):Components.notification.error("在缓存中找不到该公告，数据可能已过期。")}else Components.notification.error("公告缓存未找到，请尝试刷新页面。")})}),document.querySelectorAll(".delete-important-notice").forEach(t=>{t.addEventListener("click",a=>{const i=a.currentTarget.dataset.id;this.deleteImportantNotice(i)})})}showImportantNoticeForm(e=null){var n,o,r,l,c,d,f,u,y;const t=!!e,a=t?"编辑重要公告":"添加重要公告",i=[{type:"divider",label:"基础信息"},{name:"id",label:"ID",type:"text",value:(e==null?void 0:e.id)||`notice_${Date.now()}`,required:!0,help:"唯一标识符，创建后不建议修改",readonly:t},{name:"active",label:"是否激活",type:"checkbox",checked:e?e.active:!0,className:"form-group-toggle"},{name:"title",label:"标题",type:"text",value:(e==null?void 0:e.title)||"",required:!0},{name:"content",label:"内容",type:"textarea",value:(e==null?void 0:e.content)||"",required:!0,rows:4},{name:"expiryDate",label:"过期时间",type:"datetime-local",value:e!=null&&e.expiryDate?Utils.formatDate(e.expiryDate,"YYYY-MM-DD HH:mm").replace(" ","T"):""},{type:"divider",label:"图片设置"},{name:"imageUrl",label:"图片",type:"image-upload",value:((n=e==null?void 0:e.image)==null?void 0:n.url)||"",uploadContext:"notices"},{name:"imageAlt",label:"图片描述",type:"text",value:((o=e==null?void 0:e.image)==null?void 0:o.alt)||""},{name:"imagePosition",label:"图片位置",type:"select",value:((r=e==null?void 0:e.image)==null?void 0:r.position)||"top",options:[{value:"top",label:"上"},{value:"bottom",label:"下"},{value:"left",label:"左"},{value:"right",label:"右"}]},{name:"imageWidth",label:"图片宽度",type:"text",value:((l=e==null?void 0:e.image)==null?void 0:l.width)||"",placeholder:"例如: 100px 或 50%"},{name:"imageHeight",label:"图片高度",type:"text",value:((c=e==null?void 0:e.image)==null?void 0:c.height)||"",placeholder:"例如: 100px 或 auto"},{type:"divider",label:"投票设置"},{name:"pollActive",label:"开启投票",type:"checkbox",checked:((d=e==null?void 0:e.poll)==null?void 0:d.active)||!1,className:"form-group-toggle"},{name:"pollQuestion",label:"投票问题",type:"text",value:((f=e==null?void 0:e.poll)==null?void 0:f.question)||""},{name:"pollOptions",label:"投票选项",type:"textarea",value:(u=e==null?void 0:e.poll)!=null&&u.options?e.poll.options.map(h=>h.text).join(`
`):"",help:"每行一个选项",rows:4}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"添加",onSave:async()=>{const h=document.querySelector("#modal form"),g=Components.formBuilder.validate(h,{title:[],content:[]});if(g.isValid)try{const m=g.data;m.active=h.querySelector('[name="active"]').checked,m.imageUrl?m.image={url:m.imageUrl,alt:m.imageAlt,position:m.imagePosition,width:m.imageWidth,height:m.imageHeight}:m.image=null,delete m.imageUrl,delete m.imageAlt,delete m.imagePosition,delete m.imageWidth,delete m.imageHeight;const E=h.querySelector('[name="pollActive"]').checked,w=m.pollQuestion.trim(),C=m.pollOptions.trim().split(`
`).map(S=>S.trim()).filter(Boolean);if(E&&(!w||C.length===0)){Components.notification.error("开启投票后，必须填写投票问题和至少一个选项。");return}if(w&&C.length>0){const S=(e==null?void 0:e.poll)||{},L=new Map((S.options||[]).map(T=>[T.text,T]));m.poll={active:E,question:w,options:C.map((T,M)=>{const k=L.get(T);return{id:(k==null?void 0:k.id)||M,text:T,votes:(k==null?void 0:k.votes)||0}})}}else m.poll=null;delete m.pollQuestion,delete m.pollOptions,await api.importantNotices.update(m),Components.modal.hide(),Components.notification.success("重要公告已保存"),this.loadImportantNotices()}catch(m){Components.notification.error("保存失败: "+m.message)}}}),t){const h=document.querySelector('#modal textarea[name="content"]');h&&e.content&&(h.value=e.content);const g=document.querySelector('#modal textarea[name="pollOptions"]');g&&((y=e.poll)!=null&&y.options)&&(g.value=e.poll.options.map(m=>m.text).join(`
`))}document.querySelectorAll("#modal .form-group-toggle").forEach(h=>{const g=h.querySelector('input[type="checkbox"]');if(g){const m=document.createElement("label");m.setAttribute("for",g.id),m.className="toggle-switch",h.querySelector(".toggle-switch")||g.insertAdjacentElement("afterend",m)}})}deleteImportantNotice(e){Components.modal.confirm("确认删除","确定要删除这条重要公告吗？此操作不可撤销。",async()=>{try{await api.importantNotices.delete(e),Components.notification.success("重要公告已删除"),await this.loadImportantNotices()}catch(t){Components.notification.error("删除失败："+t.message)}})}setupArticleActions(){var e;(e=document.getElementById("addArticleBtn"))==null||e.addEventListener("click",()=>{this.showArticleForm()}),document.querySelectorAll(".edit-article").forEach(t=>{t.addEventListener("click",a=>{const i=t.dataset.id;this.editArticle(i)})}),document.querySelectorAll(".delete-article").forEach(t=>{t.addEventListener("click",a=>{const i=t.dataset.id;this.deleteArticle(i)})})}async showArticleForm(e=null){const t=!!e,a=t?"编辑文章":"添加新文章",i=[{name:"id",label:"ID (Slug)",type:"text",required:!0,value:(e==null?void 0:e.id)||"",placeholder:"e.g., my-first-article",readonly:t,help:"文章的唯一标识符，通常是URL的一部分。创建后不可修改。"},{name:"title",label:"标题",type:"text",required:!0,value:(e==null?void 0:e.title)||""},{name:"date",label:"发布日期",type:"date",required:!0,value:e?Utils.formatDate(e.date,"YYYY-MM-DD"):Utils.formatDate(new Date,"YYYY-MM-DD")},{name:"contentUrl",label:"内容文件URL",type:"text",required:!0,value:(e==null?void 0:e.contentUrl)||"",placeholder:"/articles/my-first-article.md",help:"指向Markdown文件的路径。"},{name:"excerpt",label:"摘要",type:"textarea",value:(e==null?void 0:e.excerpt)||"",rows:3},{name:"thumbnail",label:"缩略图",type:"image-upload",value:(e==null?void 0:e.thumbnail)||"",uploadContext:"articles"},{name:"tags",label:"标签",type:"text",value:(e==null?void 0:e.tags)||"",help:"用逗号分隔"},{name:"aiAssistants",label:"AI助手",type:"text",value:(e==null?void 0:e.aiAssistants)||"",placeholder:"e.g., ChatGPT, Copilot",help:"用逗号分隔使用了的AI助手"}],s=Components.formBuilder.create(i);if(Components.modal.show(a,s.outerHTML,{saveText:t?"更新":"创建",onSave:async()=>{const n=document.querySelector("#modal form"),o={id:[Utils.validation.rules.required],title:[Utils.validation.rules.required],date:[Utils.validation.rules.required],contentUrl:[Utils.validation.rules.required]},r=Components.formBuilder.validate(n,o);if(r.isValid)try{const l={...r.data};l.tags=l.tags.split(",").map(c=>c.trim()).join(","),l.aiAssistants=l.aiAssistants.split(",").map(c=>c.trim()).join(","),t?await api.articles.update(l):await api.articles.add(l),Components.modal.hide(),Components.notification.success(t?"文章已更新":"文章已创建"),await this.loadArticles()}catch(l){Components.notification.error("保存失败: "+l.message)}}}),e!=null&&e.excerpt){const n=document.querySelector('#modal textarea[name="excerpt"]');n&&(n.value=e.excerpt)}}async editArticle(e){const t=this.cache.get("articles");if(t){const a=t.find(i=>i.id==e);if(a){this.showArticleForm(a);return}}try{Components.notification.info("正在从服务器获取完整的文章数据...");const a=await api.articles.getById(e);a?this.showArticleForm(a):Components.notification.error("找不到指定的文章")}catch(a){Components.notification.error("加载文章失败: "+a.message)}}deleteArticle(e){Components.modal.confirm("确认删除","确定要删除这篇文章吗？此操作不可撤销。",async()=>{try{await api.articles.delete(e),Components.notification.success("文章已删除"),await this.loadArticles()}catch(t){Components.notification.error("删除失败: "+t.message)}})}}document.addEventListener("DOMContentLoaded",()=>{window.adminSystem=new q});window.AdminSystem=q;
